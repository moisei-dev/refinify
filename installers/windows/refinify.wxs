<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi" 
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  <Product Id="*" 
           Name="Refinify" 
           Language="1033" 
           Version="$(var.Version)" 
           Manufacturer="MoiseiDev" 
           UpgradeCode="A7C4E8D3-2B5F-4A6C-9D8E-1F3A2B4C5D6E">
    
    <Package InstallerVersion="200" 
             Compressed="yes" 
             InstallScope="perUser" 
             Platform="x64"/>

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <!-- Check for AutoHotkey v2 -->
    <Property Id="AUTOHOTKEYV2">
      <RegistrySearch Id="AutoHotkeyV2Search" 
                      Root="HKCU" 
                      Key="Software\AutoHotkey" 
                      Name="InstallDir" 
                      Type="directory" />
    </Property>

    <!-- UI Reference -->
    <UIRef Id="WixUI_InstallDir" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <!-- Features -->
    <Feature Id="ProductFeature" Title="Refinify" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="AhkComponents" />
      <ComponentRef Id="DesktopShortcut" />
      <ComponentRef Id="StartupShortcut" />
    </Feature>

    <!-- Directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="LocalAppDataFolder">
        <Directory Id="MoiseiDevFolder" Name="MoiseiDev">
          <Directory Id="INSTALLFOLDER" Name="Refinify">
            <Directory Id="RefinifyAhkFolder" Name="refinify-ahk" />
          </Directory>
        </Directory>
      </Directory>
      
      <Directory Id="DesktopFolder" />
      
      <Directory Id="StartupFolder" />
    </Directory>

    <!-- Components -->
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="MainFiles" Guid="B1C2D3E4-5F6A-7B8C-9D0E-1F2A3B4C5D6E">
        <File Id="README" Source="..\..\README.md" />
        <File Id="SystemPrompt" Source="..\..\system-prompt-completion.md" />
        <RegistryValue Root="HKCU" Key="Software\MoiseiDev\Refinify" Name="InstallPath" Type="string" Value="[INSTALLFOLDER]" KeyPath="yes" />
        <RemoveFolder Id="RemoveINSTALLFOLDER" Directory="INSTALLFOLDER" On="uninstall" />
        <RemoveFolder Id="RemoveMoiseiDevFolder" Directory="MoiseiDevFolder" On="uninstall" />
      </Component>
    </ComponentGroup>

    <!-- AutoHotkey files -->
    <ComponentGroup Id="AhkComponents" Directory="RefinifyAhkFolder">
      <Component Id="RefinifyAhk" Guid="D3E4F5A6-7B8C-9D0E-1F2A-3B4C5D6E7F8A">
        <File Id="RefinifyAhkFile" Source="..\..\refinify-ahk\refinify.ahk" />
        <File Id="RefinifyGeneric" Source="..\..\refinify-ahk\refinify-generic.ahk" />
        <File Id="JXON" Source="..\..\refinify-ahk\_JXON.ahk" />
        <RegistryValue Root="HKCU" Key="Software\MoiseiDev\Refinify" Name="AhkInstalled" Type="integer" Value="1" KeyPath="yes" />
        <RemoveFolder Id="RemoveRefinifyAhkFolder" Directory="RefinifyAhkFolder" On="uninstall" />
      </Component>
    </ComponentGroup>

    <!-- Desktop Shortcut -->
    <Component Id="DesktopShortcut" Directory="DesktopFolder" Guid="E4F5A6B7-8C9D-0E1F-2A3B-4C5D6E7F8A9B">
      <Shortcut Id="DesktopShortcut"
                Name="Refinify"
                Description="AI-powered text refinement"
                Target="[INSTALLFOLDER]refinify-ahk\refinify.ahk"
                WorkingDirectory="INSTALLFOLDER" />
      <RemoveFolder Id="DesktopFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\MoiseiDev\Refinify" Name="DesktopShortcut" Type="integer" Value="1" KeyPath="yes" />
      <Condition>INSTALLDESKTOPSHORTCUT</Condition>
    </Component>

    <!-- Startup Shortcut -->
    <Component Id="StartupShortcut" Directory="StartupFolder" Guid="F5A6B7C8-9D0E-1F2A-3B4C-5D6E7F8A9B0C">
      <Shortcut Id="StartupShortcut"
                Name="Refinify"
                Description="AI-powered text refinement"
                Target="[INSTALLFOLDER]refinify-ahk\refinify.ahk"
                WorkingDirectory="INSTALLFOLDER" />
      <RegistryValue Root="HKCU" Key="Software\MoiseiDev\Refinify" Name="StartupShortcut" Type="integer" Value="1" KeyPath="yes" />
      <Condition>RUNONSTARTUP</Condition>
    </Component>

    <!-- Properties for checkboxes -->
    <Property Id="INSTALLDESKTOPSHORTCUT" Value="1" />
    <Property Id="RUNONSTARTUP" Value="1" />
  </Product>
</Wix>