name: Release on Main

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get latest tag and determine version bump
        id: version
        run: |
          # Get the latest semantic version tag (ignore timestamp-based tags)
          LATEST_TAG=$(git tag -l "v*.*.*" | grep -E "^v[0-9]+\.[0-9]+\.[0-9]+$" | sort -V | tail -n 1 || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
            echo "No semantic version tags found, starting from v0.0.0"
          else
            echo "Latest tag: $LATEST_TAG"
          fi
          
          # Extract version numbers
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Get commit messages since last tag
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log --pretty=format:"%s" HEAD)
          else
            COMMITS=$(git log --pretty=format:"%s" ${LATEST_TAG}..HEAD)
          fi
          
          # Determine version bump based on commit messages
          if echo "$COMMITS" | grep -q "\[MAJOR\]"; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            echo "Major version bump detected"
          elif echo "$COMMITS" | grep -q "\[PATCH\]"; then
            PATCH=$((PATCH + 1))
            echo "Patch version bump detected"
          else
            MINOR=$((MINOR + 1))
            PATCH=0
            echo "Minor version bump (default)"
          fi
          
          # Generate new version
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "tag_name=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "version=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT
          echo "Generated version: ${NEW_VERSION}"
      
      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.tag_name }}" -m "Automated release for commit ${{ github.sha }}"
          git push origin "${{ steps.version.outputs.tag_name }}"
      
      - name: Create Windows artifact
        run: |
          # Create Windows-specific archive
          WINDOWS_ARCHIVE="refinify-windows-${{ steps.version.outputs.version }}.zip"
          
          # Create temporary directory structure with refinify root folder
          mkdir -p windows-release/refinify
          
          # Copy Windows-specific files into refinify folder
          cp -r refinify-ahk windows-release/refinify/
          cp README.md windows-release/refinify/
          cp system-prompt-completion.md windows-release/refinify/
          
          # Copy .env-secrets files if they exist
          find . -maxdepth 1 -name ".env-secrets*" -exec cp {} windows-release/refinify/ \; 2>/dev/null || true
          
          # Create Windows archive
          cd windows-release
          zip -r "../${WINDOWS_ARCHIVE}" refinify/
          cd ..
          
          # Clean up
          rm -rf windows-release
          
          echo "WINDOWS_ARCHIVE=${WINDOWS_ARCHIVE}" >> $GITHUB_ENV
          echo "Created Windows archive: ${WINDOWS_ARCHIVE}"
      
      - name: Create Mac artifact
        run: |
          # Create Mac-specific archive
          MAC_ARCHIVE="refinify-mac-${{ steps.version.outputs.version }}.zip"
          
          # Create temporary directory structure with refinify root folder
          mkdir -p mac-release/refinify
          
          # Copy Mac-specific files into refinify folder
          cp -r refinify-hammerspoon mac-release/refinify/
          cp README.md mac-release/refinify/
          cp system-prompt-completion.md mac-release/refinify/
          
          # Copy .env-secrets files if they exist
          find . -maxdepth 1 -name ".env-secrets*" -exec cp {} mac-release/refinify/ \; 2>/dev/null || true
          
          # Create Mac archive
          cd mac-release
          zip -r "../${MAC_ARCHIVE}" refinify/
          cd ..
          
          # Clean up
          rm -rf mac-release
          
          echo "MAC_ARCHIVE=${MAC_ARCHIVE}" >> $GITHUB_ENV
          echo "Created Mac archive: ${MAC_ARCHIVE}"
      
      - name: Build Windows MSI Installer
        run: |
          # Install WiX Toolset
          dotnet tool install --global wix
          
          # Build MSI installer
          cd installers/windows
          wix build refinify.wxs -d Version=${{ steps.version.outputs.version }} -o refinify-windows-${{ steps.version.outputs.version }}-installer.msi
          cd ../..
          
          echo "WINDOWS_INSTALLER=installers/windows/refinify-windows-${{ steps.version.outputs.version }}-installer.msi" >> $GITHUB_ENV
          echo "Created Windows installer"
      
      - name: Build Mac DMG Installer
        run: |
          # Build Mac app
          cd installers/mac
          ./build-mac-app.sh ${{ steps.version.outputs.version }}
          
          # Install create-dmg
          npm install -g create-dmg
          
          # Create DMG
          create-dmg Refinify.app . || true
          
          # Rename DMG to versioned name
          mv Refinify*.dmg refinify-mac-${{ steps.version.outputs.version }}-installer.dmg
          cd ../..
          
          echo "MAC_INSTALLER=installers/mac/refinify-mac-${{ steps.version.outputs.version }}-installer.dmg" >> $GITHUB_ENV
          echo "Created Mac installer"
      
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          release_name: Release ${{ steps.version.outputs.version }}
          body: |
            ## Release ${{ steps.version.outputs.version }}
            
            **Commit**: ${{ github.event.head_commit.message }}
            **Author**: ${{ github.event.head_commit.author.name }}
            **Timestamp**: ${{ github.event.head_commit.timestamp }}
            
            ### Downloads
            
            #### Installers (Recommended)
            - **Windows Installer**: refinify-windows-${{ steps.version.outputs.version }}-installer.msi
            - **Mac Installer**: refinify-mac-${{ steps.version.outputs.version }}-installer.dmg
            
            #### Portable Archives
            - **Windows Archive**: refinify-windows-${{ steps.version.outputs.version }}.zip
            - **Mac Archive**: refinify-mac-${{ steps.version.outputs.version }}.zip
          draft: false
          prerelease: false
      
      - name: Upload Windows Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ env.WINDOWS_ARCHIVE }}
          asset_name: ${{ env.WINDOWS_ARCHIVE }}
          asset_content_type: application/zip
      
      - name: Upload Mac Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ env.MAC_ARCHIVE }}
          asset_name: ${{ env.MAC_ARCHIVE }}
          asset_content_type: application/zip
      
      - name: Upload Windows Installer
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ env.WINDOWS_INSTALLER }}
          asset_name: refinify-windows-${{ steps.version.outputs.version }}-installer.msi
          asset_content_type: application/x-msi
      
      - name: Upload Mac Installer
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ env.MAC_INSTALLER }}
          asset_name: refinify-mac-${{ steps.version.outputs.version }}-installer.dmg
          asset_content_type: application/x-apple-diskimage