name: Release on Main

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate version tag
        id: version
        run: |
          # Generate timestamp-based tag
          TAG_NAME="release-$(date -u +'%Y%m%d-%H%M%S')"
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG_NAME}"
      
      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.version.outputs.tag_name }}" -m "Automated release for commit ${{ github.sha }}"
          git push origin "${{ steps.version.outputs.tag_name }}"
      
      - name: Create source archive
        run: |
          # Create a clean archive excluding unnecessary files
          ARCHIVE_NAME="${{ steps.version.outputs.tag_name }}-source.zip"
          
          # Create exclusion list
          cat > .archive-exclude << EOF
          .git
          .github
          node_modules
          *.log
          *.tmp
          .DS_Store
          Thumbs.db
          dist
          build
          coverage
          .env
          .env.local
          .env.*.local
          EOF
          
          # Create the archive excluding .git directory and files from exclusion list
          zip -r "${ARCHIVE_NAME}" . -x '.git/*' -x@.archive-exclude
          
          # Clean up
          rm .archive-exclude
          
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}" >> $GITHUB_ENV
          echo "Created archive: ${ARCHIVE_NAME}"
      
      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          release_name: ${{ steps.version.outputs.tag_name }}
          body: |
            Automated release for commit ${{ github.sha }}
            
            **Commit**: ${{ github.event.head_commit.message }}
            **Author**: ${{ github.event.head_commit.author.name }}
            **Timestamp**: ${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: false
      
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./${{ env.ARCHIVE_NAME }}
          asset_name: ${{ env.ARCHIVE_NAME }}
          asset_content_type: application/zip